# ---------------------------
# KidsWords project
# Data preparation-02
# Thomas Klee
# Created: 17 Apr 2017
# Updated: 21 Apr 2017
# ---------------------------

# This script requires two data files to run:
# data_CDI.csv, data_PQ.csv

# Those two files can be generated by 01_kidswords_dataprep.R
# for the purpose of anonymising the original data files and
# removing records from the website's data entry test 
# phase and the Learning to Talk project.

# load packages
library(tidyverse)
library(lubridate)

# load data from the CDI and the parent questionnaire
CDI <- read_csv("data/data_CDI.csv")
PQ <- read_csv("data/data_PQ.csv")

# load lookup table of CDI vocabulary characteristics
word_lookup<- read_csv("data/tb_CDI_word_features.csv")

# rename variables in lookup dataframe using dplyr
word_lookup <- rename(word_lookup, 
                 itemID = CDI_ItemID_CDIwf, # KidsWords item ID
                 CDI_item = CDI_Item_CDIwf, # CDI item
                 sem_field = Semantic_field_CDIwf, # semantic field of word
                 syllables = Syllables_CDIwf, # number of syllables in word
                 word_class = WordClass_CDIwf, # grammatical class of word
                 syl_structure = SylStruct_CDIwf, # syllable structure of word
                 ND = ND_CDIwf, # neighborhood density of word
                 WF = WF_CDIwf, # word frequency in English
                 WL = Length_phoneme_CDIwf, # word length in phonemes
                 IPC = IPC_CDI_wf
                 )

# remove records from the test run
CDI <- filter(CDI, CHILD_ID != 22376)
PQ <- filter(PQ, SCL_ID != 22376)

# replace incorrect birthdate in record 22826
CDI <- mutate(CDI, BIRTHDAY = replace(BIRTHDAY, CHILD_ID == 22826, "16-03-12"))

# locate records with missing sex (i_1_2) data in PQ dataframe
PQ[is.na(PQ$i_1_2), ]

# replace missing sex values in PQ dataframe based on values in CDI dataframe 
PQ <- mutate(PQ, i_1_2 = replace(i_1_2, SCL_ID == 20559, "Boy")) 
PQ <- mutate(PQ, i_1_2 = replace(i_1_2, SCL_ID == 20955, "Girl")) 
PQ <- mutate(PQ, i_1_2 = replace(i_1_2, SCL_ID == 21379, "Girl")) 
PQ <- mutate(PQ, i_1_2 = replace(i_1_2, SCL_ID == 21550, "Boy")) 
PQ <- mutate(PQ, i_1_2 = replace(i_1_2, SCL_ID == 21856, "Boy")) 
PQ <- mutate(PQ, i_1_2 = replace(i_1_2, SCL_ID == 22373, "Boy")) 
PQ <- mutate(PQ, i_1_2 = replace(i_1_2, SCL_ID == 22788, "Boy")) 
PQ <- mutate(PQ, i_1_2 = replace(i_1_2, SCL_ID == 22944, "Boy")) 
PQ <- mutate(PQ, i_1_2 = replace(i_1_2, SCL_ID == 23571, "Boy")) 
PQ <- mutate(PQ, i_1_2 = replace(i_1_2, SCL_ID == 23582, "Girl")) 
PQ <- mutate(PQ, i_1_2 = replace(i_1_2, SCL_ID == 24460, "Boy")) 

# locate records with missing birth order data in PQ
PQ[is.na(PQ$i_1_3), ]

# replace missing birth order values in PQ dataframe based on follow-up with parents
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 20565, "2nd")) 
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 20955, "1st")) 
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 20957, "1st")) 
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 21786, "1st")) 
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 21856, "2nd")) 
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 22779, "1st")) 
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 23582, "1st")) 
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 23786, "1st")) 
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 23884, "1st")) 
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 23976, "1st")) 
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 24161, "1st"))
PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 24280, "4th or more")) 
# PQ <- mutate(PQ, i_1_3 = replace(i_1_3, SCL_ID == 22325, "")) 

# locate records with missing region data in PQ
PQ[is.na(PQ$i_1_33), ]

# replace missing region values in PQ based on follow-up with parents
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 20889, "Auckland")) 
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 21302, "Auckland")) 
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 21615, "Marlborough")) 
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 21856, "Canterbury")) 
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 22209, "Wellington")) 
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 22660, "Otago")) 
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 22758, "Wellington")) 
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 23007, "Waikato")) 
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 23395, "Auckland")) 
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 23582, "Marlborough")) 
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 23723, "Auckland")) 
PQ <- mutate(PQ, i_1_33 = replace(i_1_33, SCL_ID == 24292, "Auckland")) 

# locate records with missing twin data in PQ
PQ[is.na(PQ$i_1_7), ] %>% 
  print(n = 30)

# replace missing twin data in PQ based on follow-up with parents
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 20554, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 20583, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 20589, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 20598, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 20942, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 21001, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 21014, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 21222, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 21548, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 21856, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 22199, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 22201, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 22322, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 22628, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 22635, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 22907, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 22912, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 23259, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 23437, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 23560, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 23582, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 23682, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 23687, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 23721, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 23835, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 23976, "no")) 
PQ <- mutate(PQ, i_1_7 = replace(i_1_7, SCL_ID == 24212, "no")) 

# correct data entry dates for paper-based CDIs manually entered 
# into kidswords.org by RAs from 72 parents initially recruited for
# Learning to Talk, but not enrolled in that project

CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "2uS4Ug", "07-12-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "BRene9", "11-08-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "c8A3up", "13-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "j9k7MA", "17-10-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "cHuK8S", "10-11-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "sefR5B", "24-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "3pE5ET", "09-08-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "8Pa7Pu", "23-09-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "FruS79", "22-09-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "SpEr7P", "10-12-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "Quy29a", "30-11-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "stuk45", "12-08-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "z7cr9s", "30-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "s8atre", "29-07-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "4ejuk2", "01-07-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "th39ru", "11-07-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "n5phe5", "14-05-12")) 
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "6eteza", "30-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "6hechu", "21-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "2umuch", "28-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "jepad6", "24-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "breqa6", "22-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "3hawu9", "30-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "phawa6", "04-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "je7uhA", "03-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "3U9Ruj", "16-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "f6wuHe", "20-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "cr2qEp", "16-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "fr6wRe", "22-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "NA2e8U", "23-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "TapR6d", "16-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "h3FEvu", "23-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "SteP4a", "18-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "2acRuT", "29-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "KEs6e4", "25-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "wEth5y", "09-07-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "c8uZAc", "25-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "D4Ayap", "18-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "3uCetE", "12-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "3Hut5F", "25-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "7weC5u", "28-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "yaxA6r", "12-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "mUX5Pa", "28-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "puqAh9", "22-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "gUCa3u", "04-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "qaVa58", "06-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "trUfA8", "30-07-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "Z5s2Uf", "03-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "vA3rap", "04-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "ku64Da", "09-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "7U5Asp", "30-05-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "C2Az5S", "13-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "6esPUT", "01-07-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "sWU65x", "28-07-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "cuW3ru", "22-08-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "ch7reT", "26-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "4raTHa", "13-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "3h2zuW", "19-09-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "S6nAcH", "10-09-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "St7Rad", "10-09-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "QeDr4F", "09-10-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "7awrA6", "26-08-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "T4Ucha", "19-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "WabU6a", "24-01-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "sPEt6e", "30-08-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "9UStam", "16-06-12"))
#CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "KuB57W", ""))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "7ebeBr", "26-10-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "had6aM", "19-06-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "Z3p2ub", "04-11-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "fatHa7", "12-08-12"))
CDI <- mutate(CDI, FILLEDOUT = replace(FILLEDOUT, CHILD_PASSWORD == "F9e9re", "22-10-12"))

# done to here ----------------------------------

# change date variables from character strings to POSIX dates
testdate <- parse_date_time(CDI$FILLEDOUT, "d-m-y")

DOE <- as.Date(CDIFILLEDOUT
BIRTHDAY

# create new variable (time) and assign ranks based on assessment dates

# test of concept -------------------------------

# Fake data creating a new variable (time) and assigning ranks based on dates
# http://stackoverflow.com/questions/29568956/how-to-add-a-rank-column-to-sorted-dates-in-r

set.seed(5)
dat = data.frame(date=sample(seq(as.Date("2015-01-01"), as.Date("2015-01-31"), 
                                 "1 day"), 12),
                 ID=rep(LETTERS[1:3], c(2,6,4)))

dat %>% group_by(ID) %>%
  mutate(wave = rank(date)) %>%
  arrange(ID, wave)

# work to be done -------------------------------

# test script for calculating age in months from a csv file

library(tidyverse)
library(lubridate)

datedata <- read_csv("datedata.csv")

mutate(datedata, agemos = round((DOE - DOB) / (365.25/12)))

# length(seq(datedata, from=DOB, to=DOE, by='month')) - 1 

# works, but not used --------------------------------

# vitals2 <- read_csv("tk_vitals.csv")

# change "date" variable (integer) into a date type
#vitals2$date <- ymd(vitals2$date)
#vitals2

#agedays <- ymd("20170406") - ymd("20170122") #works

# ----------------------------------------------------

#elapsed_months("2017-04-06", "2016-04-30")


# data1sub <- select(data, CHILD_ID, BIRTHDAY, FILLEDOUT)

sessionInfo()